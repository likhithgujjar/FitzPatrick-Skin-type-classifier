<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Skin Type Detector + Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
  /* General styles */
* {
  box-sizing: border-box;
}

body {
  background-color: #f5f2e9;
  color: #1b3a2f;
  font-family: 'Inter', sans-serif;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: 'Playfair Display', serif;
  color: #1f3d2c;
}

.brand {
  display: flex;
  flex-direction: column;
  line-height: 1;
  align-items: flex-end; /* aligns all children (formial & labs) to the right */
}


.formial {
  font-weight: 600;
  font-size: 2.5rem;
  line-height: 1;
}

.labs {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.6em;
  letter-spacing: 0.1em;
  text-align: left;
  transform: translateY(-0.2em);
  /* Removed margin-left: auto */
}


h1 {
  text-align: left;
  font-size: 2rem;
  margin-bottom: 1rem;
  font-weight: 600;
  color: black;
}

h2 {
  font-weight: bold;
  font-size: 2.5rem;
  text-align: center;
}

/* Container styles */
#container, #quiz {
  max-width: 420px;
  margin: 1.5rem auto;
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 1rem;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

video, canvas {
  display: block;
  width: 100%;
  border-radius: 12px;
}

#overlayBox {
  position: absolute;
  width: 180px;
  height: 220px;
  border: 3px dashed #10b981;
  top: 25%;
  left: 50%;
  transform: translate(-50%, -25%);
  z-index: 2;
  pointer-events: none;
}

/* Result box */
.result {
  margin-top: 1rem;
  text-align: center;
  padding: 1rem;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  font-weight: 600;
}

/* Form styling */
form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin: 0 auto;
  width: 80%;
}

/* Styling individual question container */
.question, .age, .gender, .skin_type {
  display: flex;
  flex-direction: column;
}

label {
  font-weight: bold;
  margin-bottom: 0.5rem;
}

/* Input and select box styling */
input[type="text"], input[type="number"], select {
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

/* Hover effect for inputs and select boxes */
input[type="text"]:hover, input[type="number"]:hover, select:hover {
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.7);
}

/* Focus effect for inputs and select boxes */
input[type="text"]:focus, input[type="number"]:focus, select:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.7);
}

/* Radio button group styling */
.radio-group {
  display: flex;
  gap: 1rem;
  margin-top: 10px;
}

.radio-group input[type="radio"] {
  display: none;
}

.radio-group label {
  background: #fff;
  padding: 10px 16px;
  border-radius: 8px;
  border: 1px solid #ddd;
  cursor: pointer;
  transition: all 0.3s ease;
}

.radio-group input[type="radio"]:checked + label {
  background: #10b981;
  color: white;
  border-color: #10b981;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
}

.radio-group label:hover {
  background-color: #f0fdfa;
  border-color: #99f6e4;
  transform: scale(1.05);
}

#issueBox {
  margin-top: 10px;
}

/* Button styling */
button[type="submit"] {
  background-color: #10b981;
  color: white;
  font-weight: 600;
  cursor: not-allowed;
  opacity: 0.5;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  transition: all 0.3s ease;
}

/* Submit button enabled state */
button[type="submit"]:enabled {
  cursor: pointer;
  opacity: 1;
}

/* Submit button hover effect */
button[type="submit"]:enabled:hover {
  background-color: #059669;
  transform: scale(1.05);
}

/* Retake & Capture button container */
#buttonContainer {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-top: 1rem;
}

/* Capture & Retake button shared styles */
#captureBtn, #retakeBtn {
  background-color: #f59e0b;
  color: white;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Retake button specific */
#retakeBtn {
  display: none; /* hidden by default */
}

/* Hover effects for both buttons */
#captureBtn:hover, #retakeBtn:hover {
  background-color: #d97706;
  transform: scale(1.05);
}
</style>
</head>

<body>
  <h1 class="logo">
    <button class="text-2xl">&#9776;</button>
    <div class="brand">
      <span class="formial">formial</span>
      <span class="labs">LABS</span>
    </div>
  </h1>
  
  
  <h2 style="font-size: 2rem;"><strong>Fitzpatrick Skin Type Detection</strong></h2>

  <div id="container">
    <div id="overlayBox"></div>
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas" width="360" height="270" style="display:none;"></canvas>
  </div>

 
<div id="buttonContainer">
  <button id="captureBtn">üì∏ Capture</button>
  <button id="retakeBtn">üîÑ Retake</button>
</div>

  
  
  <div class="result" id="result">Align your face inside the box, then tap Capture.</div>
  <div id="quiz"></div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const resultDiv = document.getElementById('result');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const quizDiv = document.getElementById('quiz');

let latestLandmarks = null;
let cameraRunning = true;
let skinResult = "";

function classifyFitzpatrick(r, g, b) {
  const brightness = 0.299 * r + 0.587 * g + 0.114 * b;

  let introText = "Based on your detected skin type, here are some personalized skincare insights tailored just for you. These are derived from your skin's natural response to sun exposure and pigmentation.";

  if (brightness > 150) {
    return {
      label: "Type I: Very fair",
      description: `${introText}\n\n‚Ä¢ ‚òÄÔ∏è Extremely sensitive to sunlight ‚Äì sunburns happen fast!\n‚Ä¢ üß¥ Always use a strong SPF 50+ sunscreen.\n‚Ä¢ üß¨ Your skin has very little melanin, which means almost no tanning ability.\n‚Ä¢ üë©‚Äçü¶∞ Common features: freckles, red or blonde hair, light eyes.\n\nüìù Tip: Carry a hat and sunglasses when outdoors. UV protection is your best friend!`,
    };
  } else if (brightness > 140) {
    return {
      label: "Type II: Fair",
      description: `${introText}\n\n‚Ä¢ üå§Ô∏è High risk of sunburn ‚Äì protect yourself early.\n‚Ä¢ üß¥ Use a high SPF (30‚Äì50) even on cloudy days.\n‚Ä¢ üß¨ Your skin has a little melanin but still struggles to tan.\n‚Ä¢ üë±‚Äç‚ôÄÔ∏è Common traits: light hair, blue/green eyes.\n\nüìù Tip: Moisturize daily and consider adding vitamin C serum for glow!`,
    };
  } else if (brightness > 120) {
    return {
      label: "Type III: Medium",
      description: `${introText}\n\n‚Ä¢ üåû Moderate risk of sunburn ‚Äì especially after long exposure.\n‚Ä¢ üß¥ SPF 30 is generally enough, reapply if staying out long.\n‚Ä¢ üß¨ You have a balanced melanin level, so you can tan slowly.\n‚Ä¢ üë© Common traits: brown hair, hazel eyes.\n\nüìù Tip: Exfoliate weekly to maintain brightness and prevent patchy tanning.`,
    };
  } else if (brightness > 90) {
    return {
      label: "Type IV: Olive",
      description: `${introText}\n\n‚Ä¢ üåÖ Tans easily and rarely burns.\n‚Ä¢ üß¥ Use SPF 15‚Äì30 to avoid long-term sun damage.\n‚Ä¢ üß¨ Richer melanin means better natural protection.\n‚Ä¢ üë©üèΩ‚Äçü¶∞ Common traits: dark hair and eyes, warm undertones.\n\nüìù Tip: Consider antioxidants in your skincare to prevent pigmentation over time.`,
    };
  } else if (brightness > 60) {
    return {
      label: "Type V: Brown",
      description: `${introText}\n\n‚Ä¢ ‚òÄÔ∏è Almost never burns, tans beautifully.\n‚Ä¢ üß¥ Still use SPF 15‚Äì30 to protect from aging and dark spots.\n‚Ä¢ üß¨ You have high melanin, offering strong UV defense.\n‚Ä¢ üåè Common among Southeast Asian and Middle Eastern skin tones.\n\nüìù Tip: Hydration is key‚Äîopt for gel-based moisturizers and brightening serums.`,
    };
  } else {
    return {
      label: "Type VI: Dark brown/Black",
      description: `${introText}\n\n‚Ä¢ üåû Highly resistant to sunburn.\n‚Ä¢ üß¥ SPF 15‚Äì30 is still essential to prevent hyperpigmentation and premature aging.\n‚Ä¢ üß¨ Very high melanin levels give your skin its rich tone and strong natural sun shield.\n‚Ä¢ üåç Common in African and Afro-Caribbean descent.\n\nüìù Tip: Even skin tone care is important‚Äîlook for niacinamide or kojic acid-based products.`,
    };
  }
}



function getColorFrom(landmarks, idx) {
  const x = Math.floor(landmarks[idx].x * canvas.width);
  const y = Math.floor(landmarks[idx].y * canvas.height);
  const pixel = ctx.getImageData(x, y, 1, 1).data;
  return [pixel[0], pixel[1], pixel[2]];
}

const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

faceMesh.onResults(results => {
  if (!cameraRunning) return;
  if (results.multiFaceLandmarks.length > 0) {
    latestLandmarks = results.multiFaceLandmarks[0];
    resultDiv.innerText = "Face aligned! Tap Capture to analyze.";
  } else {
    latestLandmarks = null;
    resultDiv.innerText = "Align your face inside the box, then tap Capture.";
  }
});

const camera = new Camera(video, {
  onFrame: async () => {
    if (cameraRunning) await faceMesh.send({ image: video });
  },
  width: 360,
  height: 270
});
camera.start();

captureBtn.onclick = () => {
  if (!latestLandmarks) {
    resultDiv.innerText = "Face not aligned. Try again.";
    return;
  }
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const indices = [1, 10, 152, 234, 454];
  const colors = indices.map(idx => getColorFrom(latestLandmarks, idx));
  const avgColor = colors.reduce((acc, [r, g, b]) => [acc[0] + r, acc[1] + g, acc[2] + b], [0, 0, 0]).map(v => Math.floor(v / colors.length));
  skinResult = classifyFitzpatrick(...avgColor);

  const resultData = classifyFitzpatrick(...avgColor);
skinResult = resultData.label;

resultDiv.innerHTML = `<strong>${resultData.label}</strong><br/><p>Submit the below form to learn more</p>`;

  cameraRunning = false;
  captureBtn.style.display = 'none';
  retakeBtn.style.display = 'inline-block';

  // Show Quiz
  quizDiv.innerHTML = `
    <form id="quizForm" style="margin-top:20px;">
      <p>Name:</p>
      <input type="text" name="name" placeholder="Enter your name" required style="width:100%;padding:8px;">
      <p>Age:</p>
      <input type="number" name="age" placeholder="Enter your age" min="1" required style="width:100%;padding:8px;">
      <p>Gender:</p>
      <select name="gender" required style="width:100%;padding:8px;">
        <option value="">Select Gender</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
      <p>Skin Type:</p>
      <select name="skinType" required style="width:100%;padding:8px;">
        <option value="">Select Skin Type</option>
        <option>Oily</option>
        <option>Dry</option>
        <option>Normal</option>
        <option>Combinational</option>
      </select>
      <p>Previous skin issues?</p>
          <div class="radio-group">
            <input type="radio" id="historyYes" name="history" value="yes" required />
            <label for="historyYes">Yes</label>
            <input type="radio" id="historyNo" name="history" value="no" required />
            <label for="historyNo">No</label>
          </div>

          <p>Want to consult specific issue?</p>
          <div class="radio-group">
            <input type="radio" id="consultYes" name="consult" value="yes" required />
            <label for="consultYes">Yes</label>
            <input type="radio" id="consultNo" name="consult" value="no" required />
            <label for="consultNo">No</label>
          </div>

          <div id="issueBox" style="display:none;">
            <input type="text" name="specificIssue" placeholder="Describe your issue..." />
          </div>

          <button type="submit" disabled>Submit</button>
        </form>`;

  // Show/Hide specific issue input
  document.querySelectorAll('input[name="consult"]').forEach(radio => {
    radio.addEventListener('change', function () {
      document.getElementById('issueBox').style.display = this.value === 'yes' ? 'block' : 'none';
      checkFormCompletion(); // Re-check after toggling visibility
    });
  });

  const quizForm = document.getElementById('quizForm');
  const submitBtn = document.querySelector('button[type="submit"]'); // Fix the submit button reference

  // Validation function
  function checkFormCompletion() {
    const name = quizForm.elements["name"].value.trim();
    const age = quizForm.elements["age"].value.trim();
    const gender = quizForm.elements["gender"].value;
    const skinType = quizForm.elements["skinType"].value;
    const history = quizForm.querySelector('input[name="history"]:checked');
    const consult = quizForm.querySelector('input[name="consult"]:checked');
    const consultValue = consult ? consult.value : null;
    const specificIssue = quizForm.elements["specificIssue"]?.value.trim();

    const allFilled = name && age && gender && skinType && history && consult &&
      (consultValue === 'no' || (consultValue === 'yes' && specificIssue));

    submitBtn.disabled = !allFilled;
  }

  // Attach listeners to all form inputs
  quizForm.querySelectorAll('input, select, textarea').forEach(input => {
    input.addEventListener('input', checkFormCompletion);
    input.addEventListener('change', checkFormCompletion);
  });

  // Submission handler
  quizForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });
    data["skinResult"] = skinResult;
    data["imageBase64"] = canvas.toDataURL();

    if (parseInt(data.age) <= 0 || isNaN(parseInt(data.age))) {
      alert('Please enter a valid positive age.');
      return;
    }

    fetch('https://script.google.com/macros/s/AKfycbzrlzTv4g7KPp9h-UR0-ldTljZpc8512YrqYNY_67aIeRj2fhZ-BSfbfqSuwGyc3HpDbQ/exec', {
      redirect: "follow",
      method: 'POST',
      body: JSON.stringify(data),
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    })
      .then(response => response.text())
      .then(responseText => {
        try {
          const parsed = JSON.parse(responseText);
          if (parsed.status === "success") {
            resultDiv.innerHTML = `<strong>${resultData.label}</strong><br/><pre style="text-align:left; white-space:pre-wrap;">${resultData.description}</pre>`;
            alert('Form submitted successfully!');
            document.getElementById('quizForm').reset();
            quizDiv.hidden=true;
            quizDiv.style.visibility='hidden';
            quizDiv.innerHTML = '';
          } else {
            alert('Submission failed. Please try again.');
          }
        } catch (e) {
          console.error('Invalid response:', responseText);
          alert('Submission failed. Please try again.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error submitting form. Please check your connection.');
      });
  });
};

retakeBtn.onclick = () => {
  cameraRunning = true;
  resultDiv.innerText = "Align your face inside the box, then tap Capture.";
  captureBtn.style.display = 'inline-block';
  retakeBtn.style.display = 'none';
  quizDiv.innerHTML = '';
};


  </script>
</body>
</html>
